<div class="container mt-4">
  <!-- Botón volver -->
  <div class="position-relative mb-4">
    <!-- Botón volver a la página anterior -->
    <a
      class="nav-link volver position-absolute start-0"
      [routerLink]="[routesPaths.cenadHome, cenadVisitado()?.idString]"
    >
      <fa-icon class="fa-2x volver" [icon]="faVolver"></fa-icon>
      <strong>Volver</strong>
    </a>

    <!-- Título centrado -->
    <h1 class="text-center m-0">CALENDARIO DE SOLICITUDES</h1>
  </div>

  <!-- Filtro de búsqueda -->
  <div class="row mb-3">
    <div class="col-md-6 mx-auto">
      <input
        type="text"
        class="form-control"
        placeholder="Filtrar recursos por nombre..."
        [value]="filtro()"
        (input)="filtro.set($any($event.target).value)"
      />
    </div>
  </div>
  <h5 class="text-center">FILTRAR POR CATEGORÍAS</h5>
  <!-- Botones de categorías -->
  <div class="row mb-3">
    <div class="col text-center">
      <!-- Botón "Todos" -->
      <button
        class="btn me-2"
        (click)="limpiarCategoria()"
        [class.active]="!categoriaSeleccionada()"
      >
        Todos
      </button>
      @if (categoriaSeleccionada() && !esCategoriaPadre(categoriaSeleccionada())) {
      <!-- Botón "Volver a categoría anterior" -->
      <button class="btn me-2 volver" (click)="volverCategoriaAnterior()">
        <fa-icon class="volver" [icon]="faSubir"></fa-icon>
      </button>
      } @if (categoriaSeleccionada()) {
      <!-- Categoría seleccionada actual -->
      <button class="btn me-2 categoriaSeleccionada" disabled>
        {{ categoriaSeleccionada()?.nombre }}
      </button>
      } @if (!categoriaSeleccionada()) {
      <!-- Si no hay categoría seleccionada, mostrar las categorías raíz -->
      <ng-container>
        @for (cat of categoriasPadre() ; track cat.idString) {
        <button class="btn me-2" (click)="seleccionarCategoria(cat)">
          {{ cat.nombre }}
        </button>
        }
      </ng-container>
      } @else {
      <b>SUBCATEGORÍAS: </b>
      <!-- Subcategorías directas -->
      <ng-container>
        @for (sub of subcategorias(); track sub.idString ) {
        <button class="btn btn-outline-secondary me-2" (click)="seleccionarCategoria(sub)">
          {{ sub.nombre }}
        </button>
        }
      </ng-container>
      }
    </div>
  </div>
  @if (recursosFiltrados().length > 0) {
  <div class="d-flex align-items-center mb-3">
    <label for="selectRecurso" class="me-2 mb-0 titulo"><b>Selecciona un recurso:</b></label>
    <div class="select-wrapper">
      <select
        id="selectRecurso"
        (change)="seleccionarRecurso($any($event.target).value)"
        class="titulo1"
      >
        <option [value]="''" class="titulo1">Selecciona un recurso</option>
        @for (r of recursosFiltrados(); track r.idString) {
        <option [value]="r.idString" class="titulo1">{{ r.nombre }}</option>
        }
      </select>
    </div>
  </div>
  } @else {
  <div class="text-muted mt-3">No se encontraron recursos.</div>
  }
  <app-calendarHeader
    [view]="view()"
    [viewDate]="viewDate()"
    (viewChange)="view.set($event)"
    (viewDateChange)="viewDate.set($event)"
  ></app-calendarHeader>

  <!-- Calendario dinámico -->
  @if (calendarVisible()) {
  <div class="card shadow p-3 mb-4">
    @switch (view()) { @case ('month') {
    <mwl-calendar-month-view
      [viewDate]="viewDate()"
      [events]="events()"
      [refresh]="refresh"
      [cellTemplate]="customMonthCell"
      [activeDayIsOpen]="true"
      [weekStartsOn]="1"
      (eventClicked)="onEventClick($event.event)"
    >
    </mwl-calendar-month-view>
    } @case ('week') {
    <mwl-calendar-week-view
      [viewDate]="viewDate()"
      [events]="events()"
      [refresh]="refresh"
      [weekStartsOn]="1"
      (eventClicked)="onEventClick($event.event)"
    >
    </mwl-calendar-week-view>
    } @case ('day') {
    <mwl-calendar-day-view
      [viewDate]="viewDate()"
      [events]="events()"
      [refresh]="refresh"
      (eventClicked)="onEventClick($event.event)"
    >
    </mwl-calendar-day-view>
    } }
  </div>
  }

  <!-- Tabla con listado de eventos -->
  <div class="mt-4">
    <h4 class="text-center">Listado de Solicitudes</h4>
    @if (eventosVisibles.length === 0) {
    <p class="text-center text-muted">No hay solicitudes registradas.</p>
    } @else {
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Unidad</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (evento of eventosVisibles; track evento.id) {
          <tr>
            <td>{{ evento.start | date : 'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ evento.end | date : 'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ evento.title }}</td>
            <td>{{ evento.meta.estado }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>
</div>
<ng-template #customMonthCell let-day="day">
  <div class="cal-cell-top">
    <span class="cal-day-number">{{ day.date | date : 'd' }}</span>
  </div>
  <div class="cal-events-day">
    @for (event of day.events; track event.idString) {
    <div
      class="cal-event-bar"
      [ngStyle]="getEventStyle(event, day.date)"
      (click)="onEventClick(event)"
    >
      {{ event.title }}
    </div>
    }
  </div>
</ng-template>
