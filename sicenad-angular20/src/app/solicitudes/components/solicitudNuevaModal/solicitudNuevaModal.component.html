@if (usuarioLogueado()?.rol === misRoles.Superadministrador) {
<button
  class="btn text-white ms-auto"
  data-bs-toggle="modal"
  data-bs-target="#modal-nueva-solicitud"
>
  {{ 'solicitudes.nuevaPlanificacion' | translate }}
</button>
} @else {
<button
  class="btn text-white ms-auto"
  data-bs-toggle="modal"
  data-bs-target="#modal-nueva-solicitud"
>
  {{ 'solicitudes.nuevaSolicitud' | translate }}
</button>
}
<div
  class="modal fade"
  id="modal-nueva-solicitud"
  tabindex="-1"
  aria-labelledby="modal-nueva-solicitud-Label"
  aria-hidden="true"
  (hidden.bs.modal)="resetForm()"
>
  <div class="modal-dialog modal-xxl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        @if (usuarioLogueado()?.rol === misRoles.Superadministrador) {
        <h1 class="modal-title fs-5" id="modal-nueva-solicitud-Label">{{ 'solicitudes.nuevaPlanificacion' | translate }}</h1>
        } @else {
        <h1 class="modal-title fs-5" id="modal-nueva-solicitud-Label">{{ 'solicitudes.nuevaSolicitud' | translate }}</h1>
        }
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="formulario" [formGroup]="solicitudForm">
          <div class="row py-2 justify-content-between">
            <div class="col-lg-2 col-md-12">
              <label class="me-2">{{ 'solicitudes.unidad' | translate | uppercase }} <sup class="text-danger">*</sup></label>
              @if (usuarioLogueado()?.rol !== misRoles.Normal) {
              <select class="form-select" aria-label="unidad" formControlName="unidad">
                <option [ngValue]="null">{{ 'solicitudes.seleccioneUnidad' | translate }}</option>
                @for (u of unidades(); track u.idString) {
                <option [ngValue]="u">{{ u.nombre }}</option>
                }
              </select>
              } @else {
              <label class="form-control">{{ miUnidad()?.nombre }}</label>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label>{{ 'solicitudes.jefeUnidad' | translate | uppercase }} <sup class="text-danger">*</sup></label>
              <input
                type="text"
                class="form-control"
                formControlName="jefeUnidadUsuaria"
                placeholder="{{ 'solicitudes.jefeUnidad' | translate }}"
                name="jefeUcoUsuaria"
              />
              @if (jefeUnidadUsuaria?.touched && jefeUnidadUsuaria?.invalid) {
              <span class="text-danger">{{ 'solicitudes.jefeObligatorio' | translate }}</span>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label for="fechaSolicitud">{{ 'solicitudes.fechaSolicitud' | translate | uppercase }} <sup class="text-danger">*</sup></label>
              <input
                type="date"
                class="form-control"
                formControlName="fechaSolicitud"
                name="fechaSolicitud"
              />
              @if (fechaSolicitud?.touched && fechaSolicitud?.invalid) {
              <span class="text-danger">{{ 'solicitudes.fechaObligatoria' | translate }}</span>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label>{{ 'solicitudes.poc' | translate | uppercase }} <sup class="text-danger">*</sup></label>
              <input
                type="text"
                class="form-control"
                formControlName="pocEjercicio"
                placeholder="{{ 'solicitudes.poc' | translate }}"
                name="pocEjercicio"
              />
              @if (pocEjercicio?.touched && pocEjercicio?.invalid) {
              <span class="text-danger">{{ 'solicitudes.pocObligatorio' | translate }}</span>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label>{{ 'solicitudes.tlfnRedactor' | translate | uppercase }} <sup class="text-danger">*</sup></label>
              <input
                type="text"
                class="form-control"
                formControlName="tlfnRedactor"
                placeholder="{{ 'solicitudes.tlfnRedactor' | translate }}"
                name="tlfnRedactor"
              />
              @if (tlfnRedactor?.touched && tlfnRedactor?.invalid) {
              <span class="text-danger">{{ 'comun.telefonoObligatorio' | translate }}</span>
              }
            </div>
          </div>
          <div class="row py-2 mt-2 justify-content-between">
            <div class="col-lg-4 col-md-12">
              @if (historialCategorias().length > 0) {
              <label class="d-block me-2 mt-2">
                {{ 'solicitudes.categoriaSeleccionada' | translate }}:
                <strong>{{
                  historialCategorias()[historialCategorias().length - 1].nombre.toUpperCase()
                }}</strong>
              </label>
              }
              <label class="me-5">{{ 'solicitudes.categoria' | translate | uppercase }}</label>
              @if ((categoriasFiltradas() || []).length > 0) {
              <select
                [formControlName]="'categoria'"
                (change)="onCategoriaChange($event)"
                class="form-select mb-3"
              >
                <option [ngValue]="null" disabled>{{ 'solicitudes.seleccionaCategoria' | translate }}</option>
                @for (c of categoriasFiltradas(); track c.idString) {
                <option [ngValue]="c">
                  {{ c.nombre.toUpperCase() }}
                </option>
                }
              </select>
              }
              <div class="d-flex gap-2 mb-2">
                @if (historialCategorias().length > 0) {
                <button (click)="retroceder()" class="btn btn-secondary">{{ 'comun.atras' | translate }}</button>
                <button (click)="borrarFiltros()" class="btn btn-danger">{{ 'solicitudes.borrarFiltros' | translate }}</button>
                }
              </div>
            </div>
            <div class="col-lg-4 col-md-12">
              <label>{{ 'solicitudes.recurso' | translate | uppercase}} <sup class="text-danger me-2">*</sup></label>
              <select name="recursos" id="recursos" formControlName="recurso">
                <option [ngValue]="null" disabled selected>{{ 'solicitudes.seleccionaRecurso' | translate }}</option>
                @for (recurso of recursos(); track recurso.idString) {
                <option [ngValue]="recurso">
                  {{ recurso.nombre }}
                </option>
                }
              </select>
              @if (recurso?.touched && recurso?.invalid) {
              <span class="text-danger">{{ 'solicitudes.recursoObligatorio' | translate }}</span>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label for="fechaInicio">{{ 'solicitudes.fechaInicio' | translate | uppercase }}: <sup class="text-danger"></sup></label>
              <input type="datetime-local" class="form-control" formControlName="fechaInicio" />
              @if (fechaInicio?.touched && fechaInicio?.invalid) {
              <span class="text-danger">{{ 'solicitudes.fechaObligatoria' | translate }}</span>
              }
            </div>
            <div class="col-lg-2 col-md-12">
              <label for="fechaFin">{{ 'solicitudes.fechaFin' | translate | uppercase }}: <sup class="text-danger"></sup></label>
              <input type="datetime-local" class="form-control" formControlName="fechaFin" />
              @if (fechaFin?.touched && fechaFin?.invalid) {
              <span class="text-danger">{{ 'solicitudes.fechaObligatoria' | translate }}</span>
              }
            </div>
          </div>
          <div class="row py-2 mt-2 justify-content-center me-3">
            <div class="col-lg-12 col-md-12">
              <label>{{ 'solicitudes.observaciones' | translate | uppercase }}</label>
              <textarea
                class="form-control"
                name="observacionesUco"
                formControlName="observaciones"
                placeholder="{{ 'solicitudes.observaciones' | translate }}"
              >
              </textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn"
          data-bs-dismiss="modal"
          (click)="resetForm()"
        >
          {{ 'comun.cerrar' | translate }}
        </button>
        @if (usuarioLogueado()?.rol === misRoles.Superadministrador) {
        <button
          type="button"
          (click)="crearPlanificacion()"
          data-bs-dismiss="modal"
          class="btn"
          [disabled]="solicitudForm.invalid"
        >
          {{ 'solicitudes.crearPlanificacion' | translate }}
        </button>
        } @else if (isAdminEsteCenad() || isGestorEsteCenad()) {
        <button
          type="button"
          (click)="crearYEnviarSolicitud()"
          data-bs-dismiss="modal"
          class="btn"
          [disabled]="solicitudForm.invalid"
        >
          {{ 'solicitudes.crearEnviarSolicitud' | translate }}
        </button>
        } @else {
        <button
          type="button"
          class="btn"
          data-bs-dismiss="modal"
          [disabled]="solicitudForm.invalid"
          (click)="crearSolicitud()"
        >
          {{ 'solicitudes.crearSolicitud' | translate }}
        </button>
        }
      </div>
    </div>
  </div>
</div>
